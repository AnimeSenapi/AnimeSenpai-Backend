generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "content", "user_data"]
}

model User {
  id                       String               @id @default(cuid())
  email                    String               @unique
  username                 String               @unique
  name                     String?
  avatar                   String?
  bio                      String?
  primaryRoleId            String
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  password                 String
  emailVerified            Boolean              @default(false)
  emailVerifiedAt          DateTime?
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  twoFactorEnabled         Boolean              @default(false)
  twoFactorSecret          String?
  lastLoginAt              DateTime?
  loginAttempts            Int                  @default(0)
  lockedUntil              DateTime?
  gdprConsent              Boolean              @default(false)
  gdprConsentAt            DateTime?
  marketingConsent         Boolean              @default(false)
  marketingConsentAt       DateTime?
  dataProcessingConsent    Boolean              @default(false)
  dataProcessingConsentAt  DateTime?
  followers                Follow[]             @relation("UserFollowers")
  following                Follow[]             @relation("UserFollowing")
  receivedFriendRequests   FriendRequest[]      @relation("ReceivedFriendRequests")
  sentFriendRequests       FriendRequest[]      @relation("SentFriendRequests")
  friendships1             Friendship[]         @relation("User1Friendships")
  friendships2             Friendship[]         @relation("User2Friendships")
  securityEvents           SecurityEvent[]
  twoFactorCodes           TwoFactorCode[]
  preferences              UserPreferences?
  additionalRoles          UserRole[]
  sessions                 UserSession[]
  primaryRole              Role                 @relation("UserPrimaryRole", fields: [primaryRoleId], references: [id])
  targetActivities         ActivityFeed[]       @relation("TargetUserActivities")
  activities               ActivityFeed[]       @relation("UserActivities")
  blockedByUsers           BlockedUser[]        @relation("BlockedByUsers")
  blockedUsers             BlockedUser[]        @relation("BlockedUsers")
  receivedMessages         Message[]            @relation("ReceivedMessages")
  sentMessages             Message[]            @relation("SentMessages")
  pushSubscriptions        PushSubscription[]
  reviewComments           ReviewComment[]
  reviewLikes              ReviewLike[]
  taggedUsers              ReviewTag[]          @relation("TaggedUsers")
  taggedInReviews          ReviewTag[]          @relation("TaggedInReviews")
  sharedLists              SharedList[]
  achievements             UserAchievement[]
  reviews                  UserAnimeReview[]
  privacySettings          UserPrivacySettings?
  reportsReceived          UserReport[]         @relation("ReportsReceived")
  reportsSubmitted         UserReport[]         @relation("ReportsSubmitted")
  reportsReviewed          UserReport[]         @relation("ReportsReviewed")

  @@index([email])
  @@index([username])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@index([lastLoginAt])
  @@index([createdAt])
  @@index([primaryRoleId])
  @@map("users")
  @@schema("auth")
}

model UserPreferences {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  theme                       String   @default("dark")
  language                    String   @default("en")
  timezone                    String   @default("UTC")
  emailNotifications          Boolean  @default(true)
  pushNotifications           Boolean  @default(true)
  weeklyDigest                Boolean  @default(true)
  profileVisibility           String   @default("public")
  showWatchHistory            Boolean  @default(true)
  showFavorites               Boolean  @default(true)
  showRatings                 Boolean  @default(true)
  autoplay                    Boolean  @default(true)
  quality                     String   @default("auto")
  subtitles                   Boolean  @default(true)
  subtitleLanguage            String   @default("en")
  onboardingCompleted         Boolean  @default(false)
  favoriteGenres              String[] @default([])
  favoriteTags                String[] @default([])
  discoveryMode               String   @default("balanced")
  useWatchHistory             Boolean  @default(true)
  useRatings                  Boolean  @default(true)
  useSearchHistory            Boolean  @default(true)
  useBrowsingPatterns         Boolean  @default(true)
  shareDataForRecommendations Boolean  @default(true)
  showActivityFeed            Boolean  @default(true)
  showFollowersCount          Boolean  @default(true)
  allowFollowers              Boolean  @default(true)
  activityPrivacy             String   @default("friends")
  notifyOnFollow              Boolean  @default(true)
  notifyOnFriendActivity      Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  user                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
  @@schema("auth")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  accessToken  String?
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  deviceInfo   String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([expiresAt])
  @@index([refreshToken])
  @@map("user_sessions")
  @@schema("auth")
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String?
  eventType String
  eventData String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([ipAddress, createdAt])
  @@map("security_events")
  @@schema("auth")
}

model TwoFactorCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  type      String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([code, used, expiresAt])
  @@map("two_factor_codes")
  @@schema("auth")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
  @@schema("auth")
}

model FriendRequest {
  id          String    @id @default(cuid())
  senderId    String
  receiverId  String
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  respondedAt DateTime?
  receiver    User      @relation("ReceivedFriendRequests", fields: [receiverId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentFriendRequests", fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
  @@index([senderId, status])
  @@map("friend_requests")
  @@schema("auth")
}

model Friendship {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  status    String   @default("accepted")
  createdAt DateTime @default(now())
  user1     User     @relation("User1Friendships", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     User     @relation("User2Friendships", fields: [user2Id], references: [id], onDelete: Cascade)

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@map("friendships")
  @@schema("auth")
}

model UserPrivacySettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  profileVisibility   String   @default("public")
  listVisibility      String   @default("public")
  activityVisibility  String   @default("public")
  friendsVisibility   String   @default("public")
  reviewsVisibility   String   @default("public")
  hiddenAnimeIds      String[] @default([])
  showAnimeList       Boolean  @default(true)
  showReviews         Boolean  @default(true)
  showActivity        Boolean  @default(true)
  showFriends         Boolean  @default(true)
  allowMessages       Boolean  @default(true)
  allowFriendRequests Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_privacy_settings")
  @@schema("user_data")
}

model SharedList {
  id            String   @id @default(cuid())
  name          String
  description   String?
  ownerId       String
  memberIds     String[] @default([])
  collaborators String[] @default([])
  animeIds      String[] @default([])
  isPublic      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  owner         User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([isPublic, createdAt(sort: Desc)])
  @@map("shared_lists")
  @@schema("user_data")
}

model ActivityFeed {
  id           String   @id @default(cuid())
  userId       String
  activityType String
  animeId      String?
  targetUserId String?
  metadata     String?
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())
  anime        Anime?   @relation(fields: [animeId], references: [id], onDelete: Cascade)
  targetUser   User?    @relation("TargetUserActivities", fields: [targetUserId], references: [id], onDelete: Cascade)
  user         User     @relation("UserActivities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([activityType, createdAt(sort: Desc)])
  @@index([isPublic, createdAt(sort: Desc)])
  @@map("activity_feed")
  @@schema("user_data")
}

model Notification {
  id         String   @id @default(cuid())
  userId     String
  fromUserId String?
  type       String
  animeId    String?
  relatedId  String?
  message    String
  actionUrl  String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type, createdAt(sort: Desc)])
  @@map("notifications")
  @@schema("user_data")
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  roles       String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
  @@schema("auth")
}

model SecurityLog {
  id        String   @id @default(cuid())
  event     String
  userId    String?
  username  String?
  ipAddress String?
  userAgent String?
  severity  String   @default("INFO")
  result    String   @default("SUCCESS")
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([userId, timestamp(sort: Desc)])
  @@index([event, timestamp(sort: Desc)])
  @@index([severity, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("security_logs")
  @@schema("auth")
}

model Anime {
  id                 String                   @id @default(cuid())
  title              String
  titleEnglish       String?
  titleJapanese      String?
  titleSynonyms      String[]                 @default([])
  slug               String                   @unique
  type               String
  source             String?
  status             String
  airing             Boolean                  @default(false)
  episodes           Int?
  duration           String?
  aired              String?
  startDate          DateTime?
  endDate            DateTime?
  season             String?
  year               Int?
  broadcast          String?
  rating             String?
  averageRating      Float?                   @default(0)
  scoredBy           Int                      @default(0)
  rank               Int?
  popularity         Int?
  members            Int                      @default(0)
  favorites          Int                      @default(0)
  viewCount          Int                      @default(0)
  ratingCount        Int                      @default(0)
  synopsis           String?
  background         String?
  producers          String[]                 @default([])
  licensors          String[]                 @default([])
  studios            String[]                 @default([])
  themes             String[]                 @default([])
  demographics       String[]                 @default([])
  tags               String[]                 @default([])
  studio             String?
  coverImage         String?
  bannerImage        String?
  trailer            String?
  trailerUrl         String?
  externalLinks      Json?
  malId              Int?                     @unique
  anilistId          Int?                     @unique
  kitsuId            Int?                     @unique
  approved           Boolean                  @default(false)
  description        String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  characters         AnimeCharacter[]
  genres             AnimeGenre[]
  streamingPlatforms AnimeStreamingPlatform[]
  themesData         AnimeTheme[]
  relatedFrom        RelatedAnime[]           @relation("RelatedFrom")
  relatedAnime       RelatedAnime[]           @relation("RelatedTo")
  activities         ActivityFeed[]
  messages           Message[]
  reviews            UserAnimeReview[]

  @@index([slug])
  @@index([status, type])
  @@index([year, season])
  @@index([viewCount(sort: Desc)])
  @@index([averageRating(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([title])
  @@index([titleEnglish])
  @@index([malId])
  @@index([anilistId])
  @@index([rank])
  @@index([popularity])
  @@index([airing])
  @@index([status, averageRating(sort: Desc)])
  @@index([type, averageRating(sort: Desc)])
  @@index([viewCount(sort: Desc), averageRating(sort: Desc)])
  @@index([year(sort: Desc), averageRating(sort: Desc)])
  @@index([status, year(sort: Desc)])
  @@map("anime")
  @@schema("content")
}

model Genre {
  id          String       @id @default(cuid())
  name        String       @unique
  slug        String       @unique
  description String?
  color       String?
  anime       AnimeGenre[]

  @@map("genres")
  @@schema("content")
}

model AnimeGenre {
  animeId String
  genreId String
  anime   Anime  @relation(fields: [animeId], references: [id], onDelete: Cascade)
  genre   Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([animeId, genreId])
  @@index([genreId, animeId])
  @@map("anime_genres")
  @@schema("content")
}

model Character {
  id          String           @id @default(cuid())
  malId       Int              @unique
  name        String
  nameKanji   String?
  imageUrl    String?
  description String?
  favorites   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  anime       AnimeCharacter[]

  @@index([malId])
  @@map("characters")
  @@schema("content")
}

model VoiceActor {
  id         String                @id @default(cuid())
  malId      Int                   @unique
  name       String
  imageUrl   String?
  language   String                @default("Japanese")
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  characters CharacterVoiceActor[]

  @@index([malId])
  @@map("voice_actors")
  @@schema("content")
}

model AnimeCharacter {
  id          String                @id @default(cuid())
  animeId     String
  characterId String
  role        String
  favorites   Int                   @default(0)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  anime       Anime                 @relation(fields: [animeId], references: [id], onDelete: Cascade)
  character   Character             @relation(fields: [characterId], references: [id], onDelete: Cascade)
  voiceActors CharacterVoiceActor[]

  @@index([animeId])
  @@index([characterId])
  @@map("anime_characters")
  @@schema("content")
}

model CharacterVoiceActor {
  id               String         @id @default(cuid())
  animeCharacterId String
  voiceActorId     String
  language         String         @default("Japanese")
  createdAt        DateTime       @default(now())
  animeCharacter   AnimeCharacter @relation(fields: [animeCharacterId], references: [id], onDelete: Cascade)
  voiceActor       VoiceActor     @relation(fields: [voiceActorId], references: [id], onDelete: Cascade)

  @@unique([animeCharacterId, voiceActorId, language])
  @@index([voiceActorId])
  @@index([animeCharacterId])
  @@map("character_voice_actors")
  @@schema("content")
}

model RelatedAnime {
  id        String   @id @default(cuid())
  animeId   String
  relatedId String
  relation  String
  createdAt DateTime @default(now())
  anime     Anime    @relation("RelatedFrom", fields: [animeId], references: [id], onDelete: Cascade)
  related   Anime    @relation("RelatedTo", fields: [relatedId], references: [id], onDelete: Cascade)

  @@index([animeId])
  @@index([relatedId])
  @@map("related_anime")
  @@schema("content")
}

model AnimeTheme {
  id        String   @id @default(cuid())
  animeId   String
  type      String
  number    Int?
  name      String
  artist    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  anime     Anime    @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@index([animeId])
  @@map("anime_themes")
  @@schema("content")
}

model StreamingPlatform {
  id        String                   @id @default(cuid())
  name      String                   @unique
  slug      String                   @unique
  logoUrl   String?
  baseUrl   String?
  color     String?
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  anime     AnimeStreamingPlatform[]

  @@map("streaming_platforms")
  @@schema("content")
}

model AnimeStreamingPlatform {
  animeId    String
  platformId String
  url        String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  anime      Anime             @relation(fields: [animeId], references: [id], onDelete: Cascade)
  platform   StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@id([animeId, platformId])
  @@index([platformId, animeId])
  @@map("anime_streaming_platforms")
  @@schema("content")
}

model UserAnimeList {
  id          String    @id @default(cuid())
  userId      String
  animeId     String
  status      String
  isFavorite  Boolean   @default(false)
  score       Int?
  progress    Int       @default(0)
  notes       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, animeId])
  @@index([userId, status])
  @@index([userId, isFavorite])
  @@index([animeId, userId])
  @@index([userId, updatedAt(sort: Desc)])
  @@index([status, updatedAt(sort: Desc)])
  @@map("user_anime_lists")
  @@schema("user_data")
}

model UserAnimeRating {
  id        String   @id @default(cuid())
  userId    String
  animeId   String
  score     Int
  review    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, animeId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([animeId, score(sort: Desc)])
  @@index([score(sort: Desc), createdAt(sort: Desc)])
  @@map("user_anime_ratings")
  @@schema("user_data")
}

model UserAnimeReview {
  id          String          @id @default(cuid())
  userId      String
  animeId     String
  title       String
  content     String
  score       Int
  isSpoiler   Boolean         @default(false)
  likes       Int             @default(0)
  dislikes    Int             @default(0)
  isPublic    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  comments    ReviewComment[]
  reviewLikes ReviewLike[]
  tags        ReviewTag[]
  anime       Anime           @relation(fields: [animeId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([animeId, isPublic, likes(sort: Desc)])
  @@index([isPublic, createdAt(sort: Desc)])
  @@index([likes(sort: Desc)])
  @@map("user_anime_reviews")
  @@schema("user_data")
}

model RecommendationFeedback {
  id           String   @id @default(cuid())
  userId       String
  animeId      String
  feedbackType String
  reason       String?
  createdAt    DateTime @default(now())

  @@unique([userId, animeId])
  @@index([userId])
  @@index([animeId])
  @@index([feedbackType])
  @@map("recommendation_feedback")
  @@schema("user_data")
}

model GroupingFeedback {
  id              String   @id @default(cuid())
  userId          String?
  animeId         String
  groupType       String   // 'series' | 'franchise' | 'ungrouped'
  action          String   // 'merge' | 'split' | 'correct' | 'create_group'
  sourceGroupId   String?  // Original group identifier
  targetGroupId   String?  // Target group identifier (for merge/split)
  confidence      String   // 'high' | 'medium' | 'low'
  createdAt       DateTime @default(now())

  @@index([animeId])
  @@index([groupType, action])
  @@index([createdAt])
  @@map("grouping_feedback")
  @@schema("user_data")
}

model GroupingPattern {
  id              String   @id @default(cuid())
  patternType     String   // 'title_pattern' | 'relationship_type' | 'studio_match'
  pattern         String   // The actual pattern (regex, relationship type, etc.)
  successCount    Int      @default(0)
  failureCount    Int      @default(0)
  lastUsed        DateTime @default(now())
  confidence      Float    @default(0.5) // 0-1, learned from feedback
  metadata        String?  // JSON for pattern-specific data
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([patternType, pattern])
  @@index([confidence(sort: Desc)])
  @@index([lastUsed])
  @@map("grouping_patterns")
  @@schema("content")
}

model UserInteraction {
  id         String   @id @default(cuid())
  userId     String
  animeId    String?
  actionType String
  metadata   String?
  duration   Int?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([animeId])
  @@index([actionType])
  @@map("user_interactions")
  @@schema("user_data")
}

model AnimeEmbedding {
  id                String   @id @default(cuid())
  animeId           String   @unique
  descriptionVector String?
  genreVector       String?
  combinedVector    String?
  version           String   @default("1.0")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([animeId])
  @@map("anime_embeddings")
  @@schema("content")
}

model ReviewLike {
  id        String          @id @default(cuid())
  userId    String
  reviewId  String
  createdAt DateTime        @default(now())
  review    UserAnimeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, reviewId])
  @@index([reviewId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("review_likes")
  @@schema("user_data")
}

model ReviewComment {
  id        String          @id @default(cuid())
  userId    String
  reviewId  String
  content   String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  review    UserAnimeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reviewId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("review_comments")
  @@schema("user_data")
}

model ReviewTag {
  id         String          @id @default(cuid())
  reviewId   String
  userId     String
  taggedBy   String
  createdAt  DateTime        @default(now())
  review     UserAnimeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  tagger     User            @relation("TaggedUsers", fields: [taggedBy], references: [id], onDelete: Cascade)
  taggedUser User            @relation("TaggedInReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([reviewId])
  @@map("review_tags")
  @@schema("user_data")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  keys      String
  userAgent String?
  createdAt DateTime @default(now())
  lastUsed  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
  @@schema("user_data")
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String
  animeId    String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  anime      Anime?   @relation(fields: [animeId], references: [id])
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId, createdAt(sort: Desc)])
  @@index([receiverId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("messages")
  @@schema("user_data")
}

model Achievement {
  id               String            @id @default(cuid())
  key              String            @unique
  baseName         String
  baseDescription  String
  icon             String
  category         String
  maxTier          Int               @default(1)
  createdAt        DateTime          @default(now())
  tiers            AchievementTier[]
  userAchievements UserAchievement[]

  @@index([category])
  @@map("achievements")
  @@schema("user_data")
}

model AchievementTier {
  id               String            @id @default(cuid())
  achievementId    String
  tier             Int
  requirement      Int
  points           Int               @default(10)
  name             String
  description      String
  createdAt        DateTime          @default(now())
  achievement      Achievement       @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  userAchievements UserAchievement[]

  @@unique([achievementId, tier])
  @@index([achievementId])
  @@index([tier])
  @@map("achievement_tiers")
  @@schema("user_data")
}

model UserAchievement {
  id            String          @id @default(cuid())
  userId        String
  achievementId String
  tierId        String
  unlockedAt    DateTime        @default(now())
  progress      Int             @default(0)
  achievement   Achievement     @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  tier          AchievementTier @relation(fields: [tierId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tierId])
  @@index([userId, unlockedAt(sort: Desc)])
  @@index([achievementId])
  @@index([tierId])
  @@map("user_achievements")
  @@schema("user_data")
}

model BlockedUser {
  id        String   @id @default(cuid())
  userId    String
  blockedId String
  reason    String?
  createdAt DateTime @default(now())
  blocked   User     @relation("BlockedByUsers", fields: [blockedId], references: [id], onDelete: Cascade)
  user      User     @relation("BlockedUsers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedId])
  @@index([userId])
  @@index([blockedId])
  @@map("blocked_users")
  @@schema("user_data")
}

model UserReport {
  id          String    @id @default(cuid())
  reporterId  String
  reportedId  String
  reason      String
  description String?
  status      String    @default("pending")
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())
  reported    User      @relation("ReportsReceived", fields: [reportedId], references: [id], onDelete: Cascade)
  reporter    User      @relation("ReportsSubmitted", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer    User?     @relation("ReportsReviewed", fields: [reviewedBy], references: [id])

  @@index([reportedId, status])
  @@index([reporterId])
  @@index([status, createdAt(sort: Desc)])
  @@map("user_reports")
  @@schema("user_data")
}

model SystemSettings {
  id                        String   @id @default(cuid())
  siteName                  String   @default("AnimeSenpai")
  siteDescription           String   @default("Track, discover, and explore your favorite anime")
  maintenanceMode           Boolean  @default(false)
  maintenanceMessage        String?
  registrationEnabled       Boolean  @default(true)
  emailVerificationRequired Boolean  @default(true)
  maxUploadSize             Int      @default(5242880)
  rateLimit                 Int      @default(100)
  sessionTimeout            Int      @default(86400)
  maxUserListItems          Int      @default(5000)
  enableRecommendations     Boolean  @default(true)
  enableSocialFeatures      Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("system_settings")
  @@schema("auth")
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  displayName     String
  description     String?
  isSystem        Boolean          @default(false)
  isDefault       Boolean          @default(false)
  priority        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  permissions     RolePermission[]
  additionalUsers UserRole[]
  primaryUsers    User[]           @relation("UserPrimaryRole")

  @@index([isSystem])
  @@index([priority])
  @@map("roles")
  @@schema("auth")
}

model Permission {
  id          String           @id @default(cuid())
  key         String           @unique
  name        String
  description String?
  category    String           @default("general")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@index([category])
  @@map("permissions")
  @@schema("auth")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  granted      Boolean    @default(true)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
  @@schema("auth")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
  @@schema("auth")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  event      String
  properties Json?
  userId     String?
  sessionId  String
  timestamp  DateTime
  url        String
  userAgent  String
  viewport   Json?
  referrer   String?

  @@index([userId])
  @@index([sessionId])
  @@index([event])
  @@index([timestamp])
  @@map("analytics_events")
  @@schema("user_data")
}

model AnalyticsSession {
  id           String   @id @default(cuid())
  sessionId    String   @unique
  userId       String?
  startTime    DateTime
  lastActivity DateTime
  pageViews    Int      @default(0)
  events       Int      @default(0)
  referrer     String?
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?

  @@index([userId])
  @@index([sessionId])
  @@index([lastActivity])
  @@map("analytics_sessions")
  @@schema("user_data")
}

model SearchAnalytics {
  id            String   @id @default(cuid())
  query         String   @unique
  count         Int      @default(0)
  totalResults  Int      @default(0)
  firstSearched DateTime @default(now())
  lastSearched  DateTime @default(now())
  filters       Json?

  @@index([query])
  @@index([count])
  @@index([lastSearched])
  @@map("search_analytics")
  @@schema("user_data")
}

model AnimeAnalytics {
  id               String   @id @default(cuid())
  animeId          String   @unique
  views            Int      @default(0)
  likes            Int      @default(0)
  shares           Int      @default(0)
  comments         Int      @default(0)
  favorites        Int      @default(0)
  firstInteraction DateTime @default(now())
  lastInteraction  DateTime @default(now())

  @@index([animeId])
  @@index([views])
  @@index([likes])
  @@index([lastInteraction])
  @@map("anime_analytics")
  @@schema("user_data")
}

model FeatureAnalytics {
  id         String   @id @default(cuid())
  feature    String   @unique
  usageCount Int      @default(0)
  firstUsed  DateTime @default(now())
  lastUsed   DateTime @default(now())

  @@index([feature])
  @@index([usageCount])
  @@index([lastUsed])
  @@map("feature_analytics")
  @@schema("user_data")
}

model UserActionAnalytics {
  id          String   @id @default(cuid())
  action      String   @unique
  target      String?
  count       Int      @default(0)
  firstAction DateTime @default(now())
  lastAction  DateTime @default(now())

  @@index([action])
  @@index([count])
  @@index([lastAction])
  @@map("user_action_analytics")
  @@schema("user_data")
}
